{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user of the CuraCare AI application, serving as both an authenticated user and a patient.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity."
        },
        "email": {
          "type": "string",
          "description": "The user's email address, used for login and as a unique identifier.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the user."
        },
        "roleId": {
          "type": "string",
          "description": "Reference to the Role entity, defining the user's access privileges. (Relationship: Role 1:N UserProfile)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user profile was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the user profile was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName",
        "roleId",
        "createdAt"
      ]
    },
    "Role": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Role",
      "type": "object",
      "description": "Defines distinct access levels and permissions within the application (e.g., 'Admin', 'Customer').",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Role entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the role (e.g., 'Admin', 'Customer'). Must be unique."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the privileges associated with this role."
        }
      },
      "required": [
        "id",
        "name",
        "description"
      ]
    },
    "Medicine": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Medicine",
      "type": "object",
      "description": "Details about a specific medicine available in the inventory, loaded from 'medicine_master.xlsx'.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Medicine entity."
        },
        "name": {
          "type": "string",
          "description": "The commercial or generic name of the medicine."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the medicine, including its uses and other relevant information."
        },
        "dosageInstructions": {
          "type": "string",
          "description": "Human-readable instructions on how the medicine should be taken (e.g., 'Take 1 tablet daily', '5mg twice a day')."
        },
        "baseDosagePerDay": {
          "type": "number",
          "description": "The numerical base dosage quantity expected to be consumed per day. Used in predictive refill calculations (e.g., 1 for '1 tablet daily', 2 for '5mg twice a day' if a unit is 5mg)."
        },
        "price": {
          "type": "number",
          "description": "The price of a single unit of the medicine."
        },
        "stockQuantity": {
          "type": "number",
          "description": "The current number of units of the medicine available in physical stock."
        },
        "reorderThreshold": {
          "type": "number",
          "description": "The minimum stock quantity level at which an alert for reordering should be triggered."
        },
        "prescriptionRequired": {
          "type": "boolean",
          "description": "A flag indicating whether a valid prescription is required to purchase this medicine."
        }
      },
      "required": [
        "id",
        "name",
        "dosageInstructions",
        "baseDosagePerDay",
        "price",
        "stockQuantity",
        "reorderThreshold",
        "prescriptionRequired"
      ]
    },
    "Order": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Order",
      "type": "object",
      "description": "Records details of a medicine purchase made by a user, loaded from 'order_history.xlsx'.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Order entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the UserProfile (patient) who placed this order. (Relationship: UserProfile 1:N Order)"
        },
        "medicineId": {
          "type": "string",
          "description": "Reference to the Medicine purchased in this order. (Relationship: Medicine 1:N Order)"
        },
        "quantity": {
          "type": "number",
          "description": "The total number of units of the medicine purchased in this specific order."
        },
        "orderDate": {
          "type": "string",
          "description": "The date and time when this order was placed or recorded.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "The current status of the order (e.g., 'Pending', 'Dispatched', 'Delivered', 'Cancelled')."
        },
        "traceId": {
          "type": "string",
          "description": "The Langfuse trace ID associated with the specific AI interaction that initiated or processed this order."
        }
      },
      "required": [
        "id",
        "userId",
        "medicineId",
        "quantity",
        "orderDate",
        "status",
        "traceId"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores individual user profile data. Each document is identified by the user's authentication UID. Access is restricted to the owning user or administrators.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, matching `request.auth.uid`."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{adminId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "A dedicated marker collection to identify users with 'Admin' privileges. The existence of a document with a user's UID in this collection grants admin access, enabling authorization independence without `get()` calls. Documents in this collection are typically empty or contain minimal data, with their `id` being the `adminId`.",
          "params": [
            {
              "name": "adminId",
              "description": "The unique identifier of an administrator user."
            }
          ]
        }
      },
      {
        "path": "/medicines/{medicineId}",
        "definition": {
          "entityName": "Medicine",
          "schema": {
            "$ref": "#/backend/entities/Medicine"
          },
          "description": "Contains details and inventory information for all medicines available in the system. Publicly readable by all authenticated users for purchasing, but only writable/updatable by admin users.",
          "params": [
            {
              "name": "medicineId",
              "description": "The unique identifier for a specific medicine."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/orders/{orderId}",
        "definition": {
          "entityName": "Order",
          "schema": {
            "$ref": "#/backend/entities/Order"
          },
          "description": "Stores individual order details, nested under the owning user's profile. Each order document includes the `userId` for explicit ownership, facilitating secure, path-based access for the user and enabling collection group queries for administrators.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who placed the order."
            },
            {
              "name": "orderId",
              "description": "The unique identifier for a specific order."
            }
          ]
        }
      },
      {
        "path": "/roles/{roleId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Defines the different roles available in the application (e.g., 'Admin', 'Customer'). This collection serves as a reference for role definitions and is generally static, with read access primarily for internal system use or by administrators.",
          "params": [
            {
              "name": "roleId",
              "description": "The unique identifier for a specific role."
            }
          ]
        }
      }
    ],
    "reasoning": "The recommended Firestore structure is designed to be highly secure, scalable, and debuggable, strictly adhering to the core design principles and mandates. Authorization Independence, a critical principle, is achieved through a multi-pronged approach:\n\n1.  **Admin Role Authorization:** Instead of relying on a `roleId` within the `UserProfile` document that would necessitate a `get()` call in security rules, a dedicated collection `/roles_admin/{adminId}` is used. An admin user is identified by the mere *existence* of a document with their `uid` in this collection (`exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid))`). This completely eliminates hierarchical authorization dependencies and allows for atomic operations and simpler rules.\n\n2.  **User-Owned Data:** For entities like `Order` that are intrinsically linked to a `UserProfile`, the `userId` is explicitly embedded within each `Order` document. By structuring orders as `/users/{userId}/orders/{orderId}`, the `userId` in the path (e.g., `request.auth.uid == userId`) and the `userId` field in the document (`resource.data.userId`) directly provide the necessary authorization context without any additional `get()` calls.\n\n**QAP (Queries as Permissions) Support:**\n\n*   **Publicly Accessible Data (Inventory):** The `/medicines` collection is designed for public read access by all authenticated users. This allows users to query for available medicines without requiring complex filtering logic in security rules. The rule simply grants read access to all authenticated users, inherently supporting a QAP for inventory listing.\n\n*   **User-Specific Data (Order History):** The `/users/{userId}/orders` subcollection enforces ownership at the path level. A user can only list (query) their own orders by targeting `users/$(request.auth.uid)/orders`. This structure ensures that `list` operations implicitly filter by the authenticated user's ID, thereby satisfying QAP for user-specific data.\n\n*   **Admin Access:** Admin users, identified by their presence in `/roles_admin`, have broad read/write access to `medicines` and can perform collection group queries on `orders` (across all users) to access refill order details, inventory, and other administrative features, satisfying their QAP requirements without compromising user data privacy.\n\n**Structural Segregation and Access Modeling:**\n\n*   **User Profiles (`/users/{userId}`):** Personal data, primarily readable by the user themselves and by admins.\n*   **Admin Roles (`/roles_admin/{adminId}`):** A simple marker collection for efficient admin role checking.\n*   **Medicine Inventory (`/medicines/{medicineId}`):** Global, publicly readable data for authenticated users, with write access restricted to admins.\n*   **User Orders (`/users/{userId}/orders/{orderId}`):** Hierarchical, private to each user, but also accessible by admins for operational purposes via collection group queries.\n*   **Role Definitions (`/roles/{roleId}`):** Static, reference data for defining application roles, primarily for backend consistency.\n\nThis design prioritizes explicit ownership, denormalized authorization context, and structural segregation to simplify security rules, enhance debuggability, and support efficient queries for both regular users and administrators."
  }
}